version: "3.8"

services:
  app:
    build: .
    ports:
      - "3000:3000"

    # Load secrets & config from .env (OPENAI_API_KEY, etc.)
    env_file:
      - .env

    environment:
      # Optional overrides / defaults
      - CHAT_MODEL=${CHAT_MODEL:-gpt-4o-mini}
      - MAX_ROWS=${MAX_ROWS:-5000}
      - DEBUG_SQL=${DEBUG_SQL:-false}

      # Required
      - OPENAI_API_KEY=${OPENAI_API_KEY}

      # Local DuckDB file INSIDE the container:
      # Make sure your host has: ./data/sales.duckdb
      - DUCKDB_FILE=/app/data/sales.duckdb

      # Safety: block md: MotherDuck URLs unless you explicitly allow it
      - ALLOW_MOTHERDUCK=false

    # Mount ONLY the data folder so the container can read the .duckdb file
    volumes:
      - ./data:/app/data

    restart: unless-stopped

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
